# SSO单点登录

多系统，单一位置登录，实现**多系统同时登录**的一种技术。

单点登录一般是用于互相授信的系统，实现单一位置登录，全系统有效的。



第三方登录与单点登录不是一回事

第三方登录：某系统，使用其他系统的用户。实现本系统登录的方式，解决信息孤岛和用户不对等的实现方案。（在京东中使用微信登录）

- 用户不对等：微信用户数量庞大，为了引流，京东可以使用过微信登录，提高访问量
- 信息孤岛：163仅是邮箱，百度仅是搜索引擎，。。。每个软件的用户信息封闭，不能共享。降低了用户体验。
  - 可以共享，只共享用户的名字。所以实现信息的共享

# 实现方案

## 1，Session跨域

所谓 Session 跨域就是摒弃了系统（Tomcat）提供的 Session，而使用自定义的类似 Session的机制来保存客户端数据的一种解决方案。

通过设置 cookie 的 domain 来实现 cookie 的跨域传递。

跨域：客户端请求时，请求的服务器，不是同一个IP，端口，域名，主机名的时候都是跨域。

域：在应用模型，一个完整的，有独立访问路径的功能集合称为一个域。如：百度称为一个应用或系统。百度下有若干的域，如：搜索引擎（www.baidu.com），百度贴（tie.baidu.com），百度知道（zhidao.baidu.com），百度地图（map.baidu.com）等。域信息，有时也称为多级域名。域的划分： 以 IP，端口，域名，主机名为标准，实现划分。

## 4，Token机制

### 传统Cookie认证

http无状态验证，通过cookie和session来保存状态信息。用户登录后，会生成一个cookie，来保存用户的信息。牛客论坛使用的就是cookie和session保存用户状态。

问题：

- 每次认证用户发送请求时，服务器就需要去创建一个记录去存储信息，用户越多，内存的开销就越大
- 不方便拓展，若分布式情况下，该请求必须访问该服务器，访问其他服务器没有保存session信息。
- CSRF（跨站请求伪造）：用户访问银行网站时，很容易受到跨站请求伪造的攻击，并且能够利用其访问其他的网址

### Token身份认证

token身份认知，服务端不需要存储用户的登录记录。Token可以保存在请求头中，也可以在cookie中。

1. 客户端请求登录
2. 服务端验证信息正确后
3. 签发一个Token给客户端
4. 后续客户端的请求都会带上该服务端签发的Token
5. 服务器收到请求后，验证客户端请求中携带的Token，若验证成功，则想客户端返回请求的数据

**优点**

- 无状态，可拓展（token保存在客户端，所以分布式情况下可拓展）
- 安全性：能够防止CSRF攻击，即使客户端使用cookie存储token，cookie仅作为一个存储机制，不作为认证，不将信息保存在服务端的session中。仅仅是为了将token信息发送给服务端

## 5，JWT机制

JSON Web Token （JWT）机制

JWT是一种**紧凑**且**自包含**的，用于在多方传递JSON对象的技术。传递的数据可以使用数字签名增加其安全性，，使用对称加密或者非对称加密

紧凑：数据小，可以通过URL，POST参数，请求头发送，数据小意味着传输速度快

自包含：使用payload数据块记录用户必要且不隐私的数据，**可以有效减少数据库访问次数**，提高代码性能

JWT应用：用户身份验证，数据信息交换

用户身份验证：一旦用户登录，每个后续请求都将包含 JWT，允许用户访问该令牌允许
的路由，服务和资源。单点登录是当今广泛使用 JWT 的一项功能，因为它的开销很小，并
且能够轻松地跨不同域使用。
数据信息交换：JWT 是一种非常方便的多方传递数据的载体，因为其可以使用数据签名
来保证数据的有效性和安全性

### 1，JWT数据结构

JWT数据结构：A.B.C    以. 分隔三部分信息

A - header 头信息
B - payload （有效荷载 ）用来记录用户的非隐私数据的
C - Signature 签名     将A+B进行加密生成C。（A，B是已经加密后的数据，C是进行再次加密）

- header
  - 数据结构： {“alg”: “加密算法名称”, “typ” : “JWT”}
    alg 是加密算法定义内容，如：HMAC SHA256 或 RSA
    typ 是 token 类型，这里固定为 JWT。
- payload
  - 在 payload 数据块中一般用于记录实体（通常为用户信息）或其他数据的。主要分为三
    个部分，分别是：已注册信息（registered claims），公开数据（public claims），私有数据（private claims）。
  - payload 中常用信息有：iss（发行者），exp（到期时间），sub（主题），aud（受众）等。前面列举的都是已注册信息。
  - 公开数据部分一般都会在 JWT 注册表中增加定义。避免和已注册信息冲突。
  - 公开数据和私有数据可以由程序员任意定义。
  - **注意：即使 JWT 有签名加密机制，但是 payload 内容都是明文记录，除非记录的是加**
    **密数据，否则不排除泄露隐私数据的可能。不推荐在 payload 中记录任何敏感数据。**
- Signature
  - 签名信息。这是一个由开发者提供的信息。是服务器验证的传递的数据是否有效安全的
    标准。在生成 JWT 最终数据的之前。先使用 header 中定义的加密算法，将 header 和 payload进行加密，并使用点进行连接。如：**加密后的 head.加密后的 payload。再使用相同的加密算法，对加密后的数据和签名信息进行加密。得到最终结果。**

### 2，JWT执行流程

![image-20220619174521470](SSO%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95.assets/image-20220619174521470.png)

**流程**

1. 客户端：post携带用户名和密码请求登录
2. 服务端：验证成功后，创建一个JWT的密文
3. 服务端将该JWT返回给客户端
4. 客户端再请求该服务器时，携带该JWT，【建议放在请求头中】（也可以放在cookie中）
5. 服务端：验证该JWT，从中获取用户信息。并返回响应给客户端













































