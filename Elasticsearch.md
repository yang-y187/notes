# 1，ES初识

## 1.1 定义

**Elasticsearch是全文搜索引擎，**即根据关键字搜索所有匹配的全文内容。是根据Java编写，并提供了restful API实现存储和检索

==**为什么不使用关系型数据库或者非关系型数据库？**==

- 使用传统数据库存储文本字段，进行全文扫描时，需要扫描整个表，表数据过多的话，查找时间会很慢。根据关键词建立索引，关键词过多后，索引也会很多，维护也很麻烦。并且添加和更新操作会重建索引，加剧了这种困难。



**全文搜索引擎：**工作原理是计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。

## 1.2 特点

- **分布式：**可快速搭建集群，分布式存储和搜索
- **高可用：**提供主分片和副本分片，主从复制；集群支持自动选主
- **异步写入：**集群本身异步写入，支持客户端异步批量写入

## 1.3 基本概念

**es与关系型数据库概念对应关系**



|       DB       |          ES          |
| :------------: | :------------------: |
|   数据库集群   |         集群         |
|   数据库实例   |         节点         |
|  数据库（db）  |    索引（index）     |
| 主库（master） |    分片（shard）     |
| 从库（slave）  | 副本分片（replicas） |
|  表（table）   |     类型（type）     |
|   行（row）    |     文档（doc）      |
|  列（column）  |    字段（field）     |
|     表结构     |   映射（mapping）    |
|      索引      |       倒排索引       |

![image.png](Elasticsearch.assets/128b018cd88a45c1ace899743564caef.png)

- **为什么要去除类型（type）？**
  - es设计index和type的初衷就是类似关系型数据库（mysql），方便管理数据之间的关系。

- **那为什么要去除？**
  - 关系型数据库中的table是独立存储的，但es中同一个index下，所有的type是存储在同一个索引中的，因此不同type中相同字段名称的定义（mapping）需要一致。
  - 不同类型的“type”存储在同一个index中，会影响lucence（es基于lucence开发）的压缩性能

## 1.4 集群，节点，分片

- 一个elasticsearch实例为一个节点
- 一个或多个拥有相同cluster.name配置的节点组成一个集群
- 节点数发生变化时，集群会重新rebalance所有数据
- 一个节点被选举为主节点时，它负责管理集群范围的所有变更（增加，删除索引，增加或者删除节点）
- 主节点并不需要涉及文档级别的变更和搜索操作
- 请求发送到集群的任意节点，每个节点都知道任意文档所处的位置，并转发请求，收集，返回数据

### 1.4.1 节点

- **候选主节点**：候选主节点**通过选举**可以成为主节点，主节点的主要职责似乎和集群操作相关的内容，创建或删除索引（index->db中的数据库），并将分片分配给相关节点。一个节点既可以为候选主节点也可以为数据节点，但因为数据节点对CPU，内存消耗大。避免资源占用大导致主节点产生影响，进而影响整个集群。为提高集群的健康性，对集群的节点做好角色的划分与隔离，选择配置较低的机器作为候选主节点
- **数据节点**：主要存储索引数据，对文档（type->db中的表）进行增删改查操作，聚合操作等。数据节点对CPU，内存，IO要求较高
- **协调节点**：搜索请求或者批量请求可能涉及到不同数据节点上的数据，这样则需要协调节点进行协调。每个节点都是一个隐式的协调节点。如果同时设置了data.master = false和data.data=false，那么此节点将成为仅协调节点。如果无特别高的QPS，协调节点最好不要分离，跟数据节点在一起就行，分开的意义不大。

### 1.4.2 分片

- **主分片（shard）**：当有大量的文档时，单节点无法有效处理过多请求。讲数据分为多个分片，放在不同服务器上。当查询的索引分布在多个分片上，es会向每个相关的分片发送查询请求，并将结果组合，应用程序无感。
- **副本分片（replicas）**:为提高集群的高可用性和查询吞吐量，则使用分片副本。主从备份，读写分离

**在集群节点数一定的情况下，增加副本分片不能提高性能，反而有所损耗。但副本分片适当多时，在集群多个节点宕机时，能尽可能的保证数据不丢失**

一个索引有n个主分片，每个主分片有m个副本分片，那么：总分片数 = n*(m+1)

### 1.4.3 关系

- 一个索引可以创建多个分片，存储在不同节点上；
- 



















































